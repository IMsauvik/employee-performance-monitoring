<!DOCTYPE html>
<html>
<head>
    <title>Quick Fix - Dependency Corruption</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 { color: #667eea; margin-top: 0; }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            font-weight: bold;
            transition: transform 0.2s;
        }
        .btn:hover {
            transform: scale(1.05);
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            display: none;
        }
        .status.show { display: block; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .log {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Quick Fix Tool</h1>
        <p>This will clean up corrupted dependency data from your localStorage.</p>
        
        <button class="btn" onclick="runFix()">üöÄ Run Fix Now</button>
        
        <div id="status" class="status">
            <div id="statusText"></div>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        function runFix() {
            const statusDiv = document.getElementById('status');
            const statusText = document.getElementById('statusText');
            const logDiv = document.getElementById('log');
            
            statusDiv.className = 'status show info';
            statusText.innerHTML = '‚è≥ Running cleanup script...';
            logDiv.innerHTML = '';
            
            let logs = [];
            
            try {
                let fixedCount = 0;
                let removedCount = 0;
                
                // Fix users
                try {
                    const users = JSON.parse(localStorage.getItem('users') || '[]');
                    const validUsers = users.filter(u => u && u.id && u.name && u.email && typeof u.name === 'string');
                    if (validUsers.length !== users.length) {
                        localStorage.setItem('users', JSON.stringify(validUsers));
                        fixedCount++;
                        const removed = users.length - validUsers.length;
                        removedCount += removed;
                        logs.push(`‚úÖ Removed ${removed} corrupted users`);
                    }
                } catch (err) {
                    logs.push(`‚ö†Ô∏è Error cleaning users: ${err.message}`);
                }
                
                // Fix tasks
                try {
                    const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
                    const validTasks = tasks.filter(t => {
                        const isValid = t && t.id && t.taskName && typeof t.taskName === 'string';
                        if (!isValid) {
                            removedCount++;
                            return false;
                        }
                        
                        // Clean blocker history
                        if (t.blockerHistory && Array.isArray(t.blockerHistory)) {
                            const originalLength = t.blockerHistory.length;
                            t.blockerHistory = t.blockerHistory.filter(b => {
                                if (!b || !b.id) return false;
                                if (b.createdAt && typeof b.createdAt !== 'string') return false;
                                if (b.resolvedAt && typeof b.resolvedAt !== 'string') return false;
                                return true;
                            });
                            if (t.blockerHistory.length < originalLength) {
                                removedCount += originalLength - t.blockerHistory.length;
                            }
                        }
                        
                        return true;
                    });
                    if (validTasks.length !== tasks.length) {
                        localStorage.setItem('tasks', JSON.stringify(validTasks));
                        fixedCount++;
                        const removed = tasks.length - validTasks.length;
                        removedCount += removed;
                        logs.push(`‚úÖ Removed ${removed} corrupted tasks`);
                    }
                } catch (err) {
                    logs.push(`‚ö†Ô∏è Error cleaning tasks: ${err.message}`);
                }
                
                // Fix dependency tasks
                try {
                    const depTasks = JSON.parse(localStorage.getItem('dependencyTasks') || '[]');
                    const validDepTasks = depTasks.filter(t => 
                        t && t.id && t.title && typeof t.title === 'string' &&
                        t.assignedTo && t.parentTaskId
                    );
                    if (validDepTasks.length !== depTasks.length) {
                        localStorage.setItem('dependencyTasks', JSON.stringify(validDepTasks));
                        fixedCount++;
                        const removed = depTasks.length - validDepTasks.length;
                        removedCount += removed;
                        logs.push(`‚úÖ Removed ${removed} corrupted dependency tasks`);
                    }
                } catch (err) {
                    logs.push(`‚ö†Ô∏è Error cleaning dependency tasks: ${err.message}`);
                }
                
                // Fix comments
                try {
                    const comments = JSON.parse(localStorage.getItem('taskComments') || '[]');
                    const validComments = comments.filter(c => 
                        c && c.id && (c.text || c.content) && c.userName && typeof c.userName === 'string'
                    );
                    if (validComments.length !== comments.length) {
                        localStorage.setItem('taskComments', JSON.stringify(validComments));
                        fixedCount++;
                        const removed = comments.length - validComments.length;
                        removedCount += removed;
                        logs.push(`‚úÖ Removed ${removed} corrupted comments`);
                    }
                } catch (err) {
                    logs.push(`‚ö†Ô∏è Error cleaning comments: ${err.message}`);
                }
                
                // Fix notifications
                try {
                    const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
                    const validNotifications = notifications.filter(n => 
                        n && n.id && n.userId && n.message && typeof n.message === 'string'
                    );
                    if (validNotifications.length !== notifications.length) {
                        localStorage.setItem('notifications', JSON.stringify(validNotifications));
                        fixedCount++;
                        const removed = notifications.length - validNotifications.length;
                        removedCount += removed;
                        logs.push(`‚úÖ Removed ${removed} corrupted notifications`);
                    }
                } catch (err) {
                    logs.push(`‚ö†Ô∏è Error cleaning notifications: ${err.message}`);
                }
                
                logDiv.innerHTML = logs.join('<br>');
                
                if (fixedCount > 0 || removedCount > 0) {
                    statusDiv.className = 'status show success';
                    statusText.innerHTML = `üéâ Success! Fixed ${fixedCount} categories, removed ${removedCount} corrupted items.<br>Redirecting to app in 3 seconds...`;
                    setTimeout(() => {
                        window.location.href = 'http://localhost:5173';
                    }, 3000);
                } else {
                    statusDiv.className = 'status show info';
                    statusText.innerHTML = '‚ú® No corrupted data found! Your storage is clean.<br>Redirecting to app in 2 seconds...';
                    setTimeout(() => {
                        window.location.href = 'http://localhost:5173';
                    }, 2000);
                }
                
            } catch (err) {
                statusDiv.className = 'status show error';
                statusText.innerHTML = `‚ùå Error: ${err.message}`;
                logDiv.innerHTML = err.stack;
            }
        }
    </script>
</body>
</html>
